---
title: "Student 3000 Criminal Data analysis through Liner Regression Analysis."
author: "2조 강준호, 권우민, 임일화, 김지연"
date: '`r Sys.Date()`'
output: html_document
---

# Data 정리하여 표를 만들기.

•W. S. Gosset 이 t-분포를 유도하느라고 모의실험에 활용한 자료를 이용하여, 

```{r,echo = FALSE, results = 'hide'}
#options(width = 180)
library(hexbin)
library(ggplot2)
library(knitr)
library(pander)
panderOptions('table.split.table', Inf)
panderOptions('table.alignment.rownames', 'left')
panderOptions('table.alignment.default', 'right')
crimtab
str(crimtab)
```

* Gosset 원자료인 Student 3000 Criminal Data를 표로 정리함.
```{r,echo = FALSE,results = 'True'}
pander(crimtab)
```

* 이러한 table 구조의 행과 열에 이름을 붙이려면, list로 부여하여, ◦cm 단위로 되어 있는 키의 계급을 인치 단위로 변환하였다.

```{r,echo = FALSE, results = 'hide'}
dimnames(crimtab)
crimtab.2 <- crimtab
colnames(crimtab.2) <- as.numeric(colnames(crimtab.2))/2.54
(dimnames(crimtab.2) <- list(finger = rownames(crimtab.2), height = colnames(crimtab.2)))
crimtab.2
str(crimtab.2)
```

* 그 결과, crimtab을 인치(inches)로 줄여서 나타낸 표.
```{r,echo = FALSE,results = 'True'}
pander(crimtab.2)
```

```{r,echo = FALSE, results = 'hide'}
crimtab.2.df <- as.data.frame(crimtab.2, stringsAsFactors = FALSE)
str(crimtab.2.df)
crimtab.2.df[1:2] <- sapply(crimtab.2.df[1:2], as.numeric)
str(crimtab.2.df)
crimtab.2.long <- mapply(function(x) rep(x, crimtab.2.df$Freq), crimtab.2.df[c("finger", "height")])
str(crimtab.2.long)
crimtab.2.long.df <- data.frame(crimtab.2.long)
str(crimtab.2.long.df)
```


#각 변수들 정규성을 검정

많은 통계적 추론에서는 자료의 독립성과 정규성(자료가 정규분포를 따른다 것을 의미함)을 가정한다. 따라서 자료의 정규성을 가정하는 통계학적인 분석 방법을 적용하고자 하는 경우에 자료가 정규분포를 따르는지 검정하고자 하는 의미에서 Q-Q 산점도를 이용한다. 

* 키와 관련된 정규성 검정.

```{r,echo =FALSE, results = 'hide'}
qqnorm(crimtab.2.long.df$height)
qqline(crimtab.2.long.df$height)
```

* 손가락과 관련된 정규성 검정.

```{r, echo = FALSE, results = 'True'}
qqnorm(crimtab.2.long.df$finger)
qqline(crimtab.2.long.df$finger)
```

위의 그림을 통해, Q-Q 산점도에 나타나는 두 변수가 직선형태를 나타낸다. 즉, 자료가 정규분포에 가깝다는 것을 의미한다.

##각 변수들 빈도표 작성.

```{r,echo = FALSE,results = 'hide'}
crimtab.2.long.df$height
table(crimtab.2.long.df$height)
(height <- table(crimtab.2.long.df$height))
str(height)
data.frame(height)
(height.table <- data.frame(height))
str(height.table)
```

* 키와 관련된 빈도표.
```{r,echo = FALSE,results = 'True'}
dimnames(height.table)<-list(c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"),c("height(inches)","Frequency"))
pander(height.table)
```

```{r,echo = FALSE,results = 'hide'}
crimtab.2.long.df$finger
table(crimtab.2.long.df$finger)
(finger <- table(crimtab.2.long.df$finger))
str(finger)
data.frame(finger)
(finger.table <- data.frame(finger))
str(finger.table)
```

* 손가락와 관련된 빈도표.
```{r,echo = FALSE,results = 'True'}
dimnames(finger.table)<-list(c("1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38"),c("finger(inches)","Frequency"))
pander(finger.table)
```

#각 변수들을 히스토그램으로 그리기.

* 키의 히스토그램 

```{r fig.width=8, fig.height=4, echo = FALSE, results = 'True'}
hist(crimtab.2.long.df$height, main="Histogram of Height", xlab="height(inches)")
```

* 손가락의 히스토그램

```{r fig.width=8, fig.height=4, echo = FALSE, results = 'True'}
hist(crimtab.2.long.df$finger, main="Histogram of Finger Length", xlab= "finger length(cm)")
```

#각 변수들을 히스토그램을 이용하여 정규곡선 그리기.

##키의 정규곡선 그리기.

```{r, echo = FALSE, results = 'hide', fig.show = 'hide'}
(crimtab.height <- hist(crimtab.2.long.df$height, plot = FALSE))
list(breaks = crimtab.height$breaks, counts = crimtab.height$counts, density = crimtab.height$density, mids = crimtab.height$mids)
crimtab.2.hist <- hist(crimtab.2.long.df$height, probability = TRUE, breaks = 55:78)
list(breaks = crimtab.2.hist$breaks, counts = crimtab.2.hist$counts, density = crimtab.2.hist$density, mids = crimtab.2.hist$mids)
```

* 키의 평균과 표준편차 구하기
```{r, echo = FALSE, results = 'True'}
summary(crimtab.2.long.df$height)
sd(crimtab.2.long.df$height)
```

*면적구하기.
```{r,echo = FALSE, results = 'hide'}
(x <- c(63, 64:67, 68))
(y <- crimtab.2.hist$density[9:13])
diff(x)
diff(x) * y
```

```{r,echo = FALSE, results = 'True'}
sum(diff(x) * y)
```

* 이론적인 정규분포 밀도함수 곡선을 히스토그램에 덧붙여 그림.
```{r, echo = FALSE, results = 'True'}
x.coord<-c(63, 68, 68, rep(67:64, each = 2), 63)
y.coord<-c(rep(0, 2), rep(rev(y), each = 2))
mean.height <- mean(crimtab.2.long.df$height)
sd.height <- sd(crimtab.2.long.df$height)
x.height <- seq(55, 78, length = 1000)
y.norm <- dnorm(x.height, mean = mean.height, sd = sd.height)
hist(crimtab.2.long.df$height, breaks = 55:78, probability = TRUE, main = "The historgram of height in crimtab", xlab = "Inches", ylab = "Proportion")
abline(v = c(63, 68), lty = 2, col = "red")
polygon(x.coord, y.coord, density = 20)
lines(x.height, y.norm, col = "red")
axis(side = 1, at = seq(55, 78, by = 2), labels = seq(55, 78, by = 2))
axis(side = 2)
```

ggplot

```{r, echo = FALSE, results = 'hide', fig.show = 'hide'}
(g1 <- ggplot(data.frame(crimtab.2.long.df$height), aes(x = crimtab.2.long.df$height)) + geom_histogram(aes(y = ..density..), binwidth = 1, breaks = 55:78, fill = "white", colour = "black"))
 (g2 <- g1 + geom_vline(xintercept = c(63, 68), linetype = "dotted", colour = "red")) 
(g3 <- g2 + theme_bw() + xlab("Inches") + ggtitle("The historgram of height in crimtab"))
(g4 <- g3 + geom_polygon(aes(x = x.coord, y = y.coord), data = data.frame(x.coord, y.coord), alpha = 0.3, fill = "red"))
x.curve <- seq(55, 78, length = 100)
y.curve <- dnorm(x.curve, mean = mean.height, sd = sd.height)
(g5 <- g4 + geom_line(aes(x = x.curve, y = y.curve), data = data.frame(x.curve, y.curve), colour = "blue"))
```

```{r,echo = FALSE,results = 'True'}
(g6 <- g5 + scale_x_continuous(breaks = seq(55, 78, by = 2), labels = seq(55, 78, by = 2)))
```

##손가락 정규곡선 그리기. 

```{r, echo = FALSE, results = 'hide', fig.show = 'hide'}
(crimtab.finger <- hist(crimtab.2.long.df$finger, plot = FALSE))
list(breaks = crimtab.finger$breaks, counts = crimtab.finger$counts, density = crimtab.finger$density, mids = crimtab.finger$mids)
crimtab.3.hist <- hist(crimtab.2.long.df$finger, probability = TRUE, breaks=seq(9.5,13.5, by=0.2))
list(breaks = crimtab.3.hist$breaks, counts = crimtab.3.hist$counts, density = crimtab.3.hist$density, mids = crimtab.3.hist$mids)
main.title <- "The historgram of figner in crimtab"
x.lab <- "Inches"
y.lab <- "Proportion"
hist(crimtab.2.long.df$finger, breaks=seq(9.5,13.5, by=0.2), probability = TRUE, main = main.title, xlab = x.lab, ylab = y.lab)
abline(v = c(11, 12), lty = 2, col = "red")
crimtab.finger$density[8:13]
y <- crimtab.3.hist$density[8:13]
#x.coord<-c(11, 12, 12, rep(breaks=seq(11.1:11.9, by=0.2), each = 2), 11)
x.coord<-c(11, 12, 12, 11.9, 11.9, 11.7, 11.7, 11.5, 11.5, 11.3, 11.3,11.1,11.1, 11)
y.coord<-c(rep(0, 2), rep(rev(y), each = 2))
list(x.coord, y.coord)
hist(crimtab.2.long.df$finger, breaks=seq(9.5,13.5, by=0.2), probability = TRUE, main = main.title, xlab = x.lab, ylab = y.lab)
abline(v = c(11, 12), lty = 2, col = "red")
polygon(x.coord, y.coord, density = 20)
```

* 손가락의 평균과 표준편차 구하기
```{r,echo = FALSE,results = 'True'}
summary(crimtab.2.long.df$finger)
sd(crimtab.2.long.df$finger)
```

* 면적 구하기
```{r,echo = FALSE, results = 'hide'}
(x <- c(11, 11:12, 12))
y
diff(x)
diff(x) * y
```

```{r,echo = FALSE, results = 'True'}
sum(diff(x) * y)
```

* 이론적인 정규분포 밀도함수 곡선을 히스토그램에 덧붙여 그림.
```{r,echo = FALSE,results = 'True'}
mean.finger <- mean(crimtab.2.long.df$finger)
sd.finger <- sd(crimtab.2.long.df$finger)
x.finger <- seq(9.5, 13.5, length = 1000)
y.norm.2 <- dnorm(x.finger, mean = mean.finger, sd = sd.finger)
hist(crimtab.2.long.df$finger, breaks=seq(9.5,13.5, by=0.2), probability = TRUE, main = main.title, xlab = x.lab, ylab = y.lab)
abline(v = c(11, 12), lty = 2, col = "red")
polygon(x.coord, y.coord, density = 20)
lines(x.finger, y.norm.2, col = "red")
axis(side = 1, at = seq(9.5, 13.5, by = 1), labels = seq(9.5, 13.5, by = 1))
axis(side = 2)
```

ggplot

```{r,echo = FALSE, results = 'hide', fig.show = 'hide'}
(g1 <- ggplot(data.frame(crimtab.2.long.df$finger), aes(x = crimtab.2.long.df$finger)) + geom_histogram(aes(y = ..density..), binwidth = 1, breaks = seq(9.5,13.5, by=0.2), fill = "white", colour = "black"))
 (g2 <- g1 + geom_vline(xintercept = c(11, 12), linetype = "dotted", colour = "red")) 
(g3 <- g2 + theme_bw() + xlab("Inches") + ggtitle("The historgram of finger in crimtab"))
(g4 <- g3 + geom_polygon(aes(x = x.coord, y = y.coord), data = data.frame(x.coord, y.coord), alpha = 0.3, fill = "red"))
x.curve <- seq(9.5, 13.5, length = 100)
y.curve <- dnorm(x.curve, mean = mean.finger, sd = sd.finger)
(g5 <- g4 + geom_line(aes(x = x.curve, y = y.curve), data = data.frame(x.curve, y.curve), colour = "blue"))
```

```{r,echo = FALSE,results = 'True'}
(g6 <- g5 + scale_x_continuous(breaks = seq(9.5, 13.5, by = 1), labels = seq(9.5, 13.5, by = 1)))
```


#키와 손가락길이의 산점도를 통한 자료의 선형성 검정. 

산점도를 그리는 이유는 회귀분석을 할때 독립변수와 종속변수 간이 선형적인지 확인하기 위한 과정이다.

1. R-base으로 그린 산점도.

```{r,echo = FALSE,results = 'True'}
par(mfrow = c(1, 2))
plot(finger ~ height, data = crimtab.2.long.df, pch = 20)
smoothScatter(crimtab.2.long.df, nbin = 32, xlab = "height", ylab = "finger")
```

2. Plot crimtab.bin.

```{r,echo = FALSE,results = 'True'}
par(mfrow = c(1, 1))
crimtab.bin <- hexbin(crimtab.2.long.df$height, crimtab.2.long.df$finger, xbins = 50)
plot(crimtab.bin, xlab = "height(inches)", ylab = "finger(inches)")
```

3. ggplot으로 그리 산점도

```{r, fig.width = 8, fig.height = 4, echo = FALSE, results = 'True'}
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point()
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(alpha = 0.5)
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(position = position_jitter(width = 1, height = 0.1), size = 0.7)
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(position = position_jitter(width = 1, height = 0.1), size = 0.7 ) + theme_bw() 
```

* 키와 손가락길이의 상관관계를 구한다.
```{r,echo = FALSE, results = 'True'}
#cor(crimtab.2.long.df, method = "pearson")
cor(crimtab.2.long.df$height, crimtab.2.long.df$finger)
```

-> 위의 결과를 통해서, 키와 손가락길이가 약 66% 정도 연관성이 있다는 것을 확인할수 있다.

# 잔차산점도를 이용한 자료의 등분산성 검정. 

```{r,echo = FALSE, results = 'True'}
crimtab.lm <- lm(finger ~ height, data = crimtab.2.long.df)
plot(crimtab.lm, which = 1)
```

-> 위의 결과를 통해서, 오차항들이 0를 중심으로 Random하게 분포하기 때문에 등분산성을 만족한다.

#키와 손가락길이의 회귀분석.

이제 이 자료를 가지고 회귀 분석을 실시한다. 우선 이 자료를 통해  2가지 가설을 가지고 있다. 

<!--<img src = "hypothesis.png" width = "160"/>-->

* 선형회귀선을 그리고 분산분석표를 작성한다.
```{r,echo = FALSE, results = 'True'}
plot(finger ~ height, data = crimtab.2.long.df)
abline(lm(finger ~ height, data = crimtab.2.long.df)$coefficient)
crimtab.lm <- lm(finger ~ height, data = crimtab.2.long.df)
summary(crimtab.lm)
```

-> 위의 회귀분석을 이용한 검정결과,

1) 회귀 모형의 R제곱이 0.43, 유의 확률이 유의 수준 0.05 < 2.2e-16 이므로 이 모형은 유의하다고 할수 있다. 즉 키와 손가락 길이가 관련성이 있다는 것을 알수 있다.

2) 회귀 계수들이 역시 유의 확률이 유의 수준 0.05 < 2.2e-16 이므로 이 회귀식에
나와있는 회귀계수들이 유의하다고 할수 있다.

* 선형회귀선과 자료의 국소적인 변화를 살피기 위하여 lowess()를 이용한
local smoother를 추가하여 비교한다.
```{r,echo = FALSE, results = 'True'}
plot(finger ~ height, data = crimtab.2.long.df)
abline(lm(finger ~ height, data = crimtab.2.long.df)$coefficient)
lines(lowess(crimtab.2.long.df$height, crimtab.2.long.df$finger),col = "red")
```

*회귀식 구하기
```{r,echo = FALSE,results = 'True'}
crimtab.lm$coeff
```

* 위의 결과로 단순회귀분석의 결과를 알 수 있는데 회귀 직선의 y절편은  2.3373879 이고 기울기는 0.1406683임을 알 수 있다. y 절편은 crimtab.lm$coeff[1]로 구할 수 있고 기울기는 crimtab.lm$coeff[2]로 구할 수 있다. 또한 p값은 summary(crimtab.lm)$coeff[2,4]로 알 수 있다. a라는 소수를 소숫점 아래 1자리에서 반올림하려면 round(a,1)과 같이 구할 수 있다. 회귀공식을 그래프에 표시하기 위해 y = ax + b 와 같은 회귀공식을 만들려면 위와 같은 과정을 일일이 입력해야 하므로 번거로우므로 이를 자동화해줄 수 있는 lm2equation이라는 함수를 하나 만들었다. 이 함수의 내용은 다음과 같다.

```{r,echo = FALSE,results = 'True'}
lm2equation=function(mydata,xvar,yvar,parse=FALSE){
    fit=eval(parse(text=paste0("lm(",yvar,"~",xvar,",data=",mydata,")")))
    intercept=round(coef(crimtab.lm)[1],5)
    slope=round(coef(crimtab.lm)[2],5)
    if(parse) equation=paste0("y==",slope,"*x",ifelse(intercept>=0,'+','-'),abs(intercept))
    else equation=paste0("y = ",slope,"x",ifelse(intercept>=0,' + ',' - '),abs(intercept))
    p=round(summary(crimtab.lm)$coeff[2,4],3)
    if(p==0) equation=paste(equation,"(p < 0.001)")
    else equation=paste(equation,"(p =",p,")")
    equation
}
lm2equation("crimtab.2.long.df","height","finger")
```

ggplot

* 선형 회귀선 및 범위 추가.
```{r, fig.width = 8, fig.height = 4, echo = FALSE, results = 'True'}
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(position = position_jitter(width = 1, height = 0.1), size = 0.7 ) + theme_bw() + stat_smooth(method=lm, level=0.95) + ggtitle("Crimtab: Linear Regression Line without Confidence Level") 
```

* loess(locally weighted polynomial) 를 써서 비모수 회귀(Nonparametric regression) 선 추가. 
```{r, fig.width = 8, fig.height = 4, echo = FALSE, results = 'True'}
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(position = position_jitter(width = 1, height = 0.1), size = 0.7 ) + theme_bw() +  stat_smooth(method=loess, level=0.95) + ggtitle("Crimtab: Linear Regression Line without Confidence Level") 
```

* 선형회귀선과 선형회귀식 레벨 붙이기.
```{r,echo = FALSE,results = 'True'}
ggplot(crimtab.2.long.df, aes(x = height, y = finger)) + geom_point(position = position_jitter(width = 1, height = 0.1), size = 0.7 ) + theme_bw() + stat_smooth(method=lm, level=0.95)+ ggtitle("Crimtab: Linear Regression Line without Confidence Level")  + annotate(geom='text',x=70,y=9.5,size=7,label=lm2equation("crimtab.2.long.df","height","finger")) + scale_colour_gradientn(colours=c("black","red"))
```

### Data 마무리.

```{r,echo = FALSE, results = 'hide'}
save.image(file="crimtab_1007.rda")
```